#!/usr/bin/env bash

if [ ! -z $PROXY ]; then
    echo "Setting HTTP and HTTPS proxy: $PROXY"
    export HTTP_PROXY=$PROXY
    export HTTPS_PROXY=$PROXY
fi

ls -l /mnt | grep -q "total 0" && {
    if [ ! -z $IMAGE_NAME -a ! -z $GIT_REPO ]; then
        GIT_URL=${GIT_REPO}/${IMAGE_NAME}
        echo "Installing from git url $GIT_URL"
        git clone $GIT_URL .
    fi
}

run-parts --exit-on-error --regex "(^[a-zA-Z0-9_.\-]+)" ${CI_WORKSPACE}/testpack/scripts/
exitval=$?

# kill supervisord after we exit, giving supervisord time to catch our exit
(sleep 1 && kill $(ps -ef | grep supervisord | egrep -v grep | head -1 | awk '{ print $2 }'))&

echo "Test runner exiting with $exitval"
exit $exitval
